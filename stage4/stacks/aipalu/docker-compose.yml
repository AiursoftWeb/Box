version: '3.9'

services:
  db:
    image: hub.aiursoft.cn/postgres:16-alpine
    volumes:
      - aipalu-db:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=aipalu
    networks:
      - internal
    stop_grace_period: 60s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
      replicas: 1
      update_config:
        order: stop-first
        delay: 60s
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3

  aipalu-main:
    image: hub.aiursoft.cn/aiursoft/aipalu/aipalu_main:latest
    depends_on:
      - db
    environment:
      - PORT=9999
      - DATABASE_URL=postgresql://user:password@db:5432/aipalu
      - JWT_KEY={{AIPALU_MAIN_JWT_KEY}}
      - PUBLIC_IMAGE_BASE_URL=https://aipalui-admin.aiursoft.cn/download/
    networks:
      - proxy_app
      - internal
    stop_grace_period: 60s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
      replicas: 1
      update_config:
        order: stop-first
        delay: 60s
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3

  authentik-proxy-main:
    depends_on:
      - aipalu-main
    image: hub.aiursoft.cn/ghcr.io/goauthentik/proxy:2025.8
    volumes:
      - type: tmpfs
        target: /dev/shm
        tmpfs:
          size: 2147483648 # 2GB
    environment:
      AUTHENTIK_HOST: "https://auth.aiursoft.cn/"
      AUTHENTIK_INSECURE: "false"
      AUTHENTIK_TOKEN: "{{AIPALU_MAIN_GATEWAY_OUTPOST_TOKEN}}"
    stop_grace_period: 20s
    networks:
      - proxy_app
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
      update_config:
        order: start-first
        delay: 5s

  aipalu-admin:
    image: hub.aiursoft.cn/aiursoft/aipalu/aipalu_admin:latest
    depends_on:
      - db
    environment:
      - ConnectionStrings__DbType=PostgreSql
      - ConnectionStrings__DefaultConnection=Server=db;Database=aipalu;Uid=user;Pwd=password;
      - Storage__Path=/data/files
      - AppSettings__AuthProvider=OIDC
      - AppSettings__OIDC__Authority=https://auth.aiursoft.cn/application/o/aipalu
      - AppSettings__OIDC__ClientId={{AIPALU_CLIENT_ID}}
      - AppSettings__OIDC__ClientSecret={{AIPALU_CLIENT_SECRET}}
    volumes:
      - admin-files:/data/files
    networks:
      - proxy_app
      - internal
    stop_grace_period: 60s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
      replicas: 1
      update_config:
        order: stop-first
        delay: 60s
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
    
  aipalu-app-figure:
    image: hub.aiursoft.cn/aiursoft/aipalu/aipalu_app_figure:latest
    depends_on:
      - aipalu-main
    volumes:
      - aipalu-app-figure:/app/gen-imgs
    environment:
      - PORT=10001
      - GOOGLE_API_KEY={{AIPALU_GOOGLE_API_KEY}}
      - PUBLIC_HOST_URL=https://aipalui.aiursoft.cn
    networks:
      - proxy_app
      - internal
    stop_grace_period: 60s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
      replicas: 1
      update_config:
        order: stop-first
        delay: 60s
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3

  aipalu-app-4-koma-manga:
    image: hub.aiursoft.cn/aiursoft/aipalu/app_4_koma_manga:latest
    depends_on:
      - aipalu-main
    environment:
      - PORT=10002
      - PUBLIC_HOST_URL=https://aipalui.aiursoft.cn/
      - VOLCENGINE_API_KEY={{AIPALU_VOLCENGINE_API_KEY}}
    networks:
      - proxy_app
      - internal
    stop_grace_period: 60s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
      replicas: 1
      update_config:
        order: stop-first
        delay: 60s
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3

  aipalu-app-cool-beauty:
    image: hub.aiursoft.cn/aiursoft/aipalu/app_cool_beauty:latest
    depends_on:
      - aipalu-main
    environment:
      - PORT=10003
      - PUBLIC_HOST_URL=https://aipalui.aiursoft.cn/
      - VOLCENGINE_API_KEY={{AIPALU_VOLCENGINE_API_KEY}}
    networks:
      - proxy_app
      - internal
    stop_grace_period: 60s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
      replicas: 1
      update_config:
        order: stop-first
        delay: 60s
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3

  aipalu-app-building-marker:
    image: hub.aiursoft.cn/aiursoft/aipalu/app_building_marker:latest
    depends_on:
      - aipalu-main
    environment:
      - PORT=10004
      - PUBLIC_HOST_URL=http://aipalu-main/
      - VOLCENGINE_API_KEY={{AIPALU_VOLCENGINE_API_KEY}}
    networks:
      - internal
      - proxy_app
    stop_grace_period: 60s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
      replicas: 1
      update_config:
        order: stop-first
        delay: 60s
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3

networks:
  internal:
    driver: overlay
  proxy_app:
    external: true

volumes:
  aipalu-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /swarm-vol/aipalu/db/data
  admin-files:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /swarm-vol/aipalu/admin/files
  aipalu-app-figure:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /swarm-vol/aipalu/app-figure/data
  
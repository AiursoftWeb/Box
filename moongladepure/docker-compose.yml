# Anduin
# JimMoen
# Rest
# Cody
# Gxhao
# Anois
# Dvorak
# Kitlau
# Xinboo
# Gbiner
# Rdf
# Lyx
# Shubuzuo
# Lily
# Carson
# ZoneBlog

version: '3.3'

services:
  anduin:
    depends_on:
      - anduin-db
    image: hub.aiursoft.cn/aiursoft/moongladepure
    volumes:
      - anduin-files:/data/files
      - anduin-aspnet:/root/.aspnet/
    environment:
        ConnectionStrings__AllowCache: 'False'
        ConnectionStrings__DefaultConnection: Server=anduin-db;Database=anduin;Uid=anduin;Pwd=<anduin_password>;
        ConnectionStrings__DbType: MySql
        Storage__Path: /data/files
    secrets:
      - source: openai-key
        target: OpenAI-Token
      - source: openai-instance
        target: OpenAI-Instance
    networks:
      - anduin_app
      - proxy_app
    deploy:
      replicas: 2
      labels:
        swarmpit.service.deployment.autoredeploy: 'true'
  
  anduin-db:
    image: hub.aiursoft.cn/mysql
    volumes:
      - anduin-db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=<root_password>
      - MYSQL_DATABASE=anduin
      - MYSQL_USER=anduin
      - MYSQL_PASSWORD=<anduin_password>
    networks:
      - anduin_app
    deploy:
      labels:
        swarmpit.service.deployment.autoredeploy: 'true'
      
  jimmoen:
    depends_on:
      - jimmoen-db
    image: hub.aiursoft.cn/aiursoft/jimmoen
    volumes:
      - jimmoen-files:/data/files
      - jimmoen-aspnet:/root/.aspnet/
    environment:
        ConnectionStrings__AllowCache: 'False'
        ConnectionStrings__DefaultConnection: Server=jimmoen-db;Database=jimmoen;Uid=jimmoen;Pwd=<jimmoen_password>;
        ConnectionStrings__DbType: MySql
        Storage__Path: /data/files
    networks:
      - jimmoen_app
      - proxy_app
    deploy:
      replicas: 2
      labels:
        swarmpit.service.deployment.autoredeploy: 'true'

  jimmoen-db:
    image: hub.aiursoft.cn/mysql
    volumes:
      - jimmoen-db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=<root_password>
      - MYSQL_DATABASE=jimmoen
      - MYSQL_USER=jimmoen
      - MYSQL_PASSWORD=<jimmoen_password>
    networks:
      - jimmoen_app
    deploy:
      labels:
        swarmpit.service.deployment.autoredeploy: 'true'

secrets:
  openai-key:
    external: true
  openai-instance:
    external: true

networks:
  proxy_app:
    external: true
  anduin_app:
    driver: overlay
  jimmoen_app:
    driver: overlay

volumes:
  anduin-aspnet:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /swarm-vol/moongladepure/anduin/aspnet
  anduin-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /swarm-vol/moongladepure/anduin/db
  anduin-files:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /swarm-vol/moongladepure/anduin/files

  jimmoen-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /swarm-vol/moongladepure/jimmoen/db
  jimmoen-aspnet:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /swarm-vol/moongladepure/jimmoen/aspnet
  jimmoen-files:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /swarm-vol/moongladepure/jimmoen/files